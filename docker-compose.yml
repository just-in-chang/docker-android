version: "4"
services:
  android-emulator:
    build:
      context: .
      args:
        - API_LEVEL=34
        - CMD_LINE_VERSION=11076708_latest
        - IMG_TYPE=google_apis
    ports:
      - 5554:5554
      - 127.0.0.1:5555:5555
    environment:
      - DISABLE_ANIMATION=false
      - DISABLE_HIDDEN_POLICY=true
      - SKIP_AUTH=false
      #- ANDROID_ADB_SERVER_ADDRESS=host.docker.internal
      - MEMORY=16384
      - CORES=16
    privileged: true
    tty: true
    stdin_open: true
    volumes:
      - ./keys/adbkey:/root/.android/adbkey:ro
      - ./keys/adbkey.pub:/root/.android/adbkey.pub:ro
      - ./android_avd:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"

  android-emulator-cuda:
    build:
      context: .
      dockerfile: ./Dockerfile.gpu
      args:
        - API_LEVEL=34
        - CMD_LINE_VERSION=11076708_latest
        - IMG_TYPE=google_apis
    ports:
      - 5554:5554
      - 127.0.0.1:5555:5555
    environment:
      - DISABLE_ANIMATION=false
      - DISABLE_HIDDEN_POLICY=true
      - SKIP_AUTH=false
      #- ANDROID_ADB_SERVER_ADDRESS=host.docker.internal
      - MEMORY=16384
      - CORES=16
    privileged: true
    tty: true
    stdin_open: true
    volumes:
      - ./keys/adbkey:/root/.android/adbkey:ro
      - ./keys/adbkey.pub:/root/.android/adbkey.pub:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  android-emulator-cuda-store:
    build:
      context: .
      dockerfile: ./Dockerfile.gpu
      args:
        - API_LEVEL=34
        - CMD_LINE_VERSION=11076708_latest
        - IMG_TYPE=google_apis_playstore
    ports:
      - 5554:5554
      - 5555:5555         # ADB port (exposed for remote scrcpy access)
      - 6080:6080         # noVNC web UI
    environment:
      - DISABLE_ANIMATION=true
      - DISABLE_HIDDEN_POLICY=true
      - SKIP_AUTH=false
      - MEMORY=8192
      - CORES=6
      - ENABLE_VNC=true
      - SCREEN_WIDTH=720
      - SCREEN_HEIGHT=1280
      - SCREEN_DPI=280
      # NVIDIA GPU settings
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      # GPU performance optimizations
      - LIBGL_ALWAYS_INDIRECT=0
      - __GLX_VENDOR_LIBRARY_NAME=nvidia
      - __GL_SYNC_TO_VBLANK=0
      - __GL_THREADED_OPTIMIZATIONS=1
      # GPU_MODE: Auto-detected based on environment
      # - Native Linux: Uses 'host' for GPU acceleration
      # - WSL2/Docker: Uses 'swangle_indirect' for software rendering
      # Uncomment below to override: host, swangle_indirect, swiftshader_indirect
      # - GPU_MODE_OVERRIDE=host
    privileged: true
    tty: true
    stdin_open: true
    devices:
      - /dev/kvm:/dev/kvm           # KVM hardware acceleration
      - /dev/dri:/dev/dri           # Direct Rendering Infrastructure for GPU
    volumes:
      - ./keys/adbkey:/root/.android/adbkey:ro
      - ./keys/adbkey.pub:/root/.android/adbkey.pub:ro
      - ./android_avd_store:/data
      # Mount NVIDIA driver files for GPU access (WSL-only, commented out for native Linux)
      # - /usr/lib/wsl:/usr/lib/wsl:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    shm_size: '8gb'                 # Large shared memory for GPU gaming performance
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, graphics, utility, compute]
